name: Release

on:
  push:
    tags: ['v*']

permissions:
  contents: write

jobs:
  release:
    runs-on: windows-latest

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Rust Cache
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: src-tauri

      - name: Install Dependencies
        run: npm ci

      - name: Debug - Check Signing Key
        shell: pwsh
        run: |
          if ($env:TAURI_SIGNING_PRIVATE_KEY) {
            Write-Host "✓ TAURI_SIGNING_PRIVATE_KEY is set (length: $($env:TAURI_SIGNING_PRIVATE_KEY.Length))"
          } else {
            Write-Error "✗ TAURI_SIGNING_PRIVATE_KEY is NOT set!"
          }
          Write-Host "ℹ TAURI_SIGNING_PRIVATE_KEY_PASSWORD is not set (no password)"
        env:
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}

      - name: Build Release
        run: npm run tauri build
        env:
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}

      - name: Debug - List Build Artifacts
        shell: pwsh
        run: |
          Write-Host "Build artifacts in bundle/nsis:"
          Get-ChildItem -Path "src-tauri/target/release/bundle/nsis" | ForEach-Object {
            Write-Host "  - $($_.Name) ($([math]::Round($_.Length / 1MB, 2)) MB)"
          }

      - name: Create latest.json for updater
        shell: pwsh
        run: |
          $version = "${{ github.ref_name }}".TrimStart('v')
          $exe = Get-ChildItem -Path "src-tauri/target/release/bundle/nsis" -Filter "*.exe" | Select-Object -First 1
          $sig = Get-ChildItem -Path "src-tauri/target/release/bundle/nsis" -Filter "*.sig" | Select-Object -First 1

          if (-not $exe) {
            Write-Error "Missing .exe file"
            exit 1
          }

          if (-not $sig) {
            Write-Error "Missing .sig file - code signing failed. Check TAURI_SIGNING_PRIVATE_KEY secrets."
            exit 1
          }

          Write-Host "✓ Found signature file - creating latest.json with updater support"
          $json = @{
            version = $version
            notes = "Release $version - See full changelog at https://github.com/${{ github.repository }}/releases/tag/${{ github.ref_name }}"
            pub_date = (Get-Date).ToUniversalTime().ToString("yyyy-MM-ddTHH:mm:ssZ")
            platforms = @{
              "windows-x86_64" = @{
                signature = (Get-Content $sig.FullName -Raw).Trim()
                url = "https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/$($exe.Name)"
              }
            }
          } | ConvertTo-Json -Depth 10

          Set-Content -Path "latest.json" -Value $json
          Write-Host "Created latest.json:"
          Get-Content "latest.json"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            src-tauri/target/release/bundle/nsis/*.exe
            src-tauri/target/release/bundle/nsis/*.sig
            latest.json
          draft: false
          prerelease: false
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
